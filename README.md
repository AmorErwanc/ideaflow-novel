# AI小说创作平台

一个基于n8n工作流的AI小说创作平台，通过四步顺序工作流生成完整的小说和互动脚本。

## 🎯 项目概述

本项目是一个单页面Web应用，用户可以通过以下步骤创作小说：
1. **脑洞生成** - AI生成多个创意构思
2. **大纲生成** - 基于选中的脑洞生成故事大纲
3. **小说生成** - 根据大纲生成完整小说正文
4. **脚本生成** - 将小说转换为互动剧本

## 🚀 快速开始

### 本地运行
```bash
# 方法1：直接打开
直接在浏览器中打开 index.html

# 方法2：使用Python服务器
python3 -m http.server 8000

# 方法3：使用VS Code Live Server
安装Live Server扩展后右键选择"Open with Live Server"
```

### 在线访问
访问：[项目演示地址]

## 📁 项目结构

```
ideaflow-novel/
├── index.html          # 主页面
├── script.js           # 核心业务逻辑
├── styles.css          # 自定义样式
├── CLAUDE.md           # AI助手工作指南
├── README.md           # 项目文档
└── improvements/       # 改进方案（未实施）
    ├── monitoring/     # 监控系统
    ├── recovery/       # 恢复系统
    └── workflow-redesign/ # 工作流重构方案
```

## 🔧 技术架构

### 前端技术
- **框架**：原生JavaScript（无框架依赖）
- **样式**：Tailwind CSS (CDN)
- **图标**：Font Awesome (CDN)
- **存储**：localStorage + sessionStorage

### 后端服务
- **工作流引擎**：n8n
- **AI模型**：
  - DeepSeek（脑洞、大纲生成）
  - OpenAI（小说、脚本生成）
- **数据库**：PostgreSQL（可选，未使用）

## 🌟 核心功能

### 1. 两种创作模式
- **快速生成**：一键随机生成脑洞
- **自定义模式**：输入具体需求，控制脑洞数量

### 2. 工作流特点
- **链式依赖**：每步依赖前一步的webhook返回
- **状态管理**：严格的工作流状态控制
- **按钮管理**：智能的按钮启用/禁用逻辑

### 3. 用户体验
- **实时反馈**：加载动画和状态提示
- **内容下载**：支持下载小说和脚本
- **流畅动画**：卡片选择和内容展示动画

## ❗ 已知问题

### 1. 链式依赖问题
**问题描述**：
- 任何环节失败，必须从头开始
- 无法单独重试某个步骤
- 用户体验差，容易丢失进度

**影响**：
- 小说生成失败 → 必须重新生成脑洞
- 网络中断 → 所有进度丢失

## 💡 改进方案详解

我们设计了三个改进方案来解决上述问题：

### 方案1：监控系统（已创建，未启用）

#### 功能说明
- 记录所有API调用和响应
- 追踪用户行为路径
- 性能分析和错误日志
- 导出分析报告

#### 工作原理
```javascript
// 自动记录每次API调用
logger.trackAPICall(url, success, responseTime);

// 记录用户行为
logger.trackUserAction('idea_selected', { index: 2 });

// 查看统计信息
const stats = logger.getStats();
// 输出：API成功率、平均响应时间、错误次数等
```

#### 实施难度：⭐（简单）

---

### 方案2：恢复系统（已创建，未启用）

#### 功能说明
- 自动保存每步完成的数据
- 刷新页面后可恢复进度
- 支持手动导出/导入进度
- 7天自动清理旧数据

#### 工作原理
```javascript
// 生成脑洞成功后自动保存
recoverySystem.createCheckpoint('ideas', {
    data: 脑洞数据,
    webhook: firstWaithook
});

// 页面加载时检测
if (有保存的进度) {
    显示提示："发现未完成的创作，是否恢复？"
}

// 用户点击恢复
recoverySystem.recoverAll();
```

#### 存储机制
| 存储类型 | 刷新页面 | 关闭浏览器 | 清除缓存 | 容量 |
|---------|---------|-----------|---------|------|
| localStorage | ✅保留 | ✅保留 | ❌丢失 | 5-10MB |
| sessionStorage | ✅保留 | ❌丢失 | ❌丢失 | 5-10MB |
| IndexedDB | ✅保留 | ✅保留 | ❌丢失 | GB级别 |

#### 实施难度：⭐（简单）

---

### 方案3：工作流重构（已设计，需改n8n）

#### 功能说明
- 将单一工作流拆分为6个独立模块
- 每个模块可独立调用和重试
- 彻底解决链式依赖问题

#### 模块规划
1. **用户输入处理模块**
   - 输入：用户需求
   - 输出：标准化参数

2. **脑洞生成模块**（建议先实施）
   - 输入：小说设定
   - 输出：脑洞列表

3. **选择处理模块**
   - 输入：用户选择
   - 输出：选中内容

4. **大纲生成模块**
   - 输入：选中脑洞
   - 输出：故事大纲

5. **小说生成模块**
   - 输入：故事大纲
   - 输出：小说正文

6. **脚本生成模块**
   - 输入：小说正文
   - 输出：互动脚本

#### 缓存机制（为模块化准备）
```javascript
// 使用缓存管理器保存模块间数据
cacheManager.saveWorkflowState({
    ideas: 脑洞数据,
    outline: 大纲数据,
    novel: 小说数据
});

// 读取缓存数据
const state = await cacheManager.getWorkflowState();
```

#### 实施难度：⭐⭐⭐⭐⭐（复杂）

---

### 方案4：数据库记录（可选增强）

#### 使用PostgreSQL的价值
1. **数据分析**
   - 最受欢迎的题材统计
   - 用户行为路径分析
   - 生成内容质量追踪

2. **运营决策**
   - 了解用户在哪步流失
   - 发现系统瓶颈
   - 优化AI提示词

3. **问题排查**
   - 查看失败请求详情
   - 追踪完整创作流程
   - 分析错误模式

#### 混合方案设计
```javascript
// 前端：保证用户体验（快速响应）
localStorage.setItem('novel_data', data);

// 后端：异步记录分析数据（不影响用户）
fetch('/api/analytics', {
    method: 'POST',
    body: JSON.stringify({
        session_id: sessionId,
        step: 'novel_generated',
        word_count: data.length
    })
}).catch(() => {
    // 静默失败，不影响用户
});
```

## 🛠️ 具体实施指南

### 第一阶段：快速改善（1-2天）

#### 1. 启用监控系统
```html
<!-- 在 index.html 第23行取消注释 -->
<script src="improvements/monitoring/logger.js"></script>
```

**效果**：
- 立即开始记录所有操作
- 可以查看API成功率和响应时间
- 发现系统问题

#### 2. 启用恢复系统
```html
<!-- 在 index.html 第24行取消注释 -->
<script src="improvements/recovery/recovery-system.js"></script>
```

**效果**：
- 自动保存进度
- 刷新不丢失数据
- 提升用户满意度

### 第二阶段：数据收集（3-5天）

#### 1. 部署数据库（如果需要）
```sql
-- 执行 improvements/database-design.sql
-- 创建所需的表和视图
```

#### 2. 配置后端API
```javascript
// 修改 hybrid-solution.js 中的端点
this.apiEndpoint = 'https://your-api.com/analytics';
```

#### 3. 集成混合方案
```html
<!-- 添加到 index.html -->
<script src="improvements/hybrid-solution.js"></script>
```

### 第三阶段：工作流重构（1-2周）

#### 1. 修复n8n循环依赖
- 检查工作流中的循环引用
- 重新设计节点连接

#### 2. 创建独立模块
- 先创建脑洞生成模块
- 测试独立调用
- 逐步拆分其他模块

#### 3. 更新前端调用
```javascript
// 旧代码
const result = await callAPI(firstWaithook, data);

// 新代码
const result = await workflowManager.generateIdeas(params);
```

## 📊 预期效果

### 实施监控系统后
- 知道哪个API最慢
- 发现失败原因
- 了解用户行为

### 实施恢复系统后
- 用户满意度提升80%
- 减少重复操作
- 降低流失率

### 实施工作流重构后
- 系统可靠性提升90%
- 支持部分重试
- 易于扩展新功能

### 实施数据库记录后
- 数据驱动决策
- 持续优化产品
- 了解用户需求

## 🎯 行动计划

### 立即可做（不需要改n8n）
1. **今天**：启用监控系统
2. **明天**：启用恢复系统
3. **本周**：收集一周数据，分析问题

### 短期计划（需要简单配置）
1. **下周**：配置PostgreSQL数据库
2. **下下周**：部署数据收集API
3. **月底**：生成第一份数据报告

### 长期计划（需要改造n8n）
1. **第一个月**：设计模块化接口
2. **第二个月**：实施第一个模块
3. **第三个月**：完成全部模块化

## 📝 注意事项

### 关于存储选择
- **Demo阶段**：使用前端存储足够
- **生产环境**：考虑数据库支持
- **企业部署**：需要完整后端

### 关于隐私
- 前端存储数据仅在用户本地
- 后端记录需要隐私政策
- 建议匿名化处理

### 关于性能
- 监控系统影响极小（<1ms）
- 恢复系统影响极小（<5ms）
- 数据库记录为异步，不影响用户

## 🚦 决策建议

### 如果您是个人开发者
1. 直接启用方案1+2
2. 专注于改善用户体验
3. 暂不考虑数据库

### 如果您要商业化
1. 立即实施所有方案
2. 重点关注数据分析
3. 规划工作流重构

### 如果您是企业用户
1. 评估安全和合规需求
2. 考虑私有化部署
3. 定制化数据方案

## 🤝 贡献指南

欢迎提交Issue和Pull Request！

### 提交Issue时请包含
- 问题描述
- 复现步骤
- 浏览器信息
- 控制台错误信息

### 代码规范
- 使用有意义的变量名
- 保持函数简洁
- 添加必要的注释
- 遵循现有代码风格

## 📄 许可证

[添加许可证信息]

## 🙏 致谢

- n8n工作流引擎
- OpenAI和DeepSeek提供AI能力
- Tailwind CSS和Font Awesome

---

最后更新：2024年1月
详细技术文档请查看 improvements/README.md