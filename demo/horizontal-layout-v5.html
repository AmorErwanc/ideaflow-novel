<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI小说创作平台 - 简化进度条版</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        /* 进度条样式 */
        .progress-line {
            height: 4px;
            background: #e5e7eb;
            position: relative;
            transition: all 0.5s ease;
        }
        
        .progress-line.active {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .progress-line.completed {
            background: #10b981;
        }
        
        /* 步骤节点样式 */
        .step-node {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .step-node.active {
            border-color: #10b981;
            transform: scale(1.1);
            box-shadow: 0 0 0 8px rgba(16, 185, 129, 0.1);
        }
        
        .step-node.completed {
            background: #10b981;
            border-color: #10b981;
        }
        
        .step-node.completed .step-icon {
            color: white;
        }
        
        /* 脉冲动画 */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        .step-node.active {
            animation: pulse 2s infinite;
        }
        
        /* 内容区域切换动画 */
        .content-panel {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .content-panel.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 模式选择卡片 */
        .mode-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .mode-card:hover::before {
            left: 100%;
        }
        
        .mode-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* 流式输出相关样式 */
        .skeleton-card {
            position: relative;
            overflow: hidden;
        }
        
        .skeleton-text {
            background: #f0f0f0;
            border-radius: 4px;
            min-height: 1.2em;
            position: relative;
            overflow: hidden;
        }
        
        .skeleton-text::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: skeleton-wave 1.5s infinite;
        }
        
        @keyframes skeleton-wave {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* 打字机光标效果 */
        .typewriter-cursor {
            display: inline-block;
            animation: cursor-blink 1s infinite;
            color: #10b981;
            font-weight: bold;
            margin-left: 2px;
        }
        
        @keyframes cursor-blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        
        /* 流式加载动画 */
        .stream-loading {
            text-align: center;
            padding: 2rem;
        }
        
        .stream-loading-animation {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stream-dot {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: stream-pulse 1.4s ease-in-out infinite;
        }
        
        .stream-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .stream-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes stream-pulse {
            0%, 80%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            40% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }
        
        /* 卡片样式 */
        .idea-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .idea-card:hover:not(.skeleton-card) {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-color: #10b981;
        }
        
        .idea-card.selected {
            border: 2px solid #10b981;
            background: #f0fdf4;
        }
        
        .idea-number {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .idea-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.75rem;
            padding-right: 3rem;
            min-height: 1.5em;
        }
        
        .idea-content {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1rem;
            min-height: 3em;
        }
        
        .select-idea-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .select-idea-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .select-idea-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 卡片进入动画 */
        .stream-card-enter {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .stream-card-visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        /* 卡片完成动画 */
        .card-complete {
            animation: card-complete-pulse 0.3s ease;
        }
        
        @keyframes card-complete-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* 标签样式 */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .step-container {
                overflow-x: auto;
                padding-bottom: 1rem;
            }
            
            .step-wrapper {
                min-width: 600px;
            }
        }
        
        /* 可编辑内容样式 */
        .editable {
            position: relative;
            cursor: default;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            min-height: 1.5em;
            display: inline-block;
        }
        
        .editable[contenteditable="true"] {
            background-color: white;
            outline: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            cursor: text;
        }
        
        /* 编辑按钮组 */
        .edit-controls {
            display: none;
            margin-left: 10px;
            gap: 6px;
        }
        
        .edit-controls.show {
            display: inline-flex;
        }
        
        .edit-controls button {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-controls .save-btn {
            background: #10b981;
            color: white;
        }
        
        .edit-controls .save-btn:hover {
            background: #059669;
        }
        
        .edit-controls .cancel-btn {
            background: #ef4444;
            color: white;
        }
        
        .edit-controls .cancel-btn:hover {
            background: #dc2626;
        }
        
        .edit-icon {
            margin-left: 6px;
            color: #3b82f6;
            font-size: 12px;
            opacity: 0;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .edit-icon:hover {
            opacity: 1 !important;
            color: #2563eb;
            transform: scale(1.1);
        }
        
        /* 当父元素悬停时显示编辑图标 */
        .idea-title:hover .edit-icon:not(.editing),
        .idea-content:hover .edit-icon:not(.editing),
        h4:hover .edit-icon:not(.editing),
        h5:hover .edit-icon:not(.editing),
        p:hover .edit-icon:not(.editing) {
            opacity: 0.6;
        }
        
        .editable.editing .edit-icon {
            display: none;
        }
        
        /* 保存提示 */
        .save-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .save-hint.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- 保存提示 -->
    <div id="saveHint" class="save-hint">
        <i class="fas fa-check-circle mr-2"></i>
        <span>已自动保存</span>
    </div>
    <!-- 导航栏 -->
    <nav class="bg-white shadow-md py-2 px-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-rocket text-lg text-green-600 mr-2"></i>
                <span class="text-base font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                    AI小说创作平台
                </span>
            </div>
            <div class="flex items-center gap-3">
                <span id="modeIndicator" class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-medium hidden">
                    <i class="fas fa-bolt mr-1 text-xs"></i>灵感速写模式
                </span>
                <button class="text-gray-600 hover:text-gray-800 transition-colors text-sm">
                    <i class="fas fa-save mr-1 text-sm"></i>保存
                </button>
                <button class="text-gray-600 hover:text-gray-800 transition-colors text-sm">
                    <i class="fas fa-history mr-1 text-sm"></i>历史
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="max-w-7xl mx-auto py-6 px-4">
        <!-- 进度指示器 - 只显示5个步骤 -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <!-- 步骤指示器 - 5个步骤（不显示创意输入） -->
            <div class="step-container">
                <div class="step-wrapper flex items-center justify-between relative px-6 py-2">
                    <!-- 连接线 -->
                    <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 flex px-16">
                        <div class="progress-line flex-1 mx-2" id="line0"></div>
                        <div class="progress-line flex-1 mx-2" id="line1"></div>
                        <div class="progress-line flex-1 mx-2" id="line2"></div>
                        <div class="progress-line flex-1 mx-2" id="line3"></div>
                    </div>
                    
                    <!-- 步骤节点 - 5个（可点击） -->
                    <div class="step-node active cursor-pointer" data-step="0" data-display-index="0" onclick="goToStep(0)">
                        <i class="fas fa-compass step-icon text-sm"></i>
                    </div>
                    <div class="step-node cursor-not-allowed opacity-50" data-step="2" data-display-index="1" onclick="goToStep(2)">
                        <i class="fas fa-brain step-icon text-sm text-gray-400"></i>
                    </div>
                    <div class="step-node cursor-not-allowed opacity-50" data-step="3" data-display-index="2" onclick="goToStep(3)">
                        <i class="fas fa-list-alt step-icon text-sm text-gray-400"></i>
                    </div>
                    <div class="step-node cursor-not-allowed opacity-50" data-step="4" data-display-index="3" onclick="goToStep(4)">
                        <i class="fas fa-book step-icon text-sm text-gray-400"></i>
                    </div>
                    <div class="step-node cursor-not-allowed opacity-50" data-step="5" data-display-index="4" onclick="goToStep(5)">
                        <i class="fas fa-film step-icon text-sm text-gray-400"></i>
                    </div>
                </div>
            </div>
            
            <!-- 步骤标签 - 5个（可点击） -->
            <div class="flex justify-between px-6 mt-2 text-xs">
                <button onclick="goToStep(0)" class="step-label text-sm font-medium text-green-600 hover:text-green-700 transition-colors cursor-pointer" data-step="0">模式选择</button>
                <button onclick="goToStep(2)" class="step-label text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors cursor-pointer" data-step="2" disabled>脑洞生成</button>
                <button onclick="goToStep(3)" class="step-label text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors cursor-pointer" data-step="3" disabled>大纲创作</button>
                <button onclick="goToStep(4)" class="step-label text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors cursor-pointer" data-step="4" disabled>小说撰写</button>
                <button onclick="goToStep(5)" class="step-label text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors cursor-pointer" data-step="5" disabled>脚本生成</button>
            </div>
        </div>

        <!-- 内容展示区 -->
        <div class="bg-white rounded-xl shadow-xl p-8">
            <!-- 步骤0: 模式选择 -->
            <div id="step0Content" class="content-panel active">
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-compass text-indigo-500 mr-2"></i>选择创作模式
                    </h3>
                    <p class="text-gray-600">选择适合你的创作方式，开启AI辅助创作之旅</p>
                </div>
                
                <!-- 模式选择卡片 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- 快速创作模式 -->
                    <div class="mode-card bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-8 shadow-lg" data-mode="quick">
                        <div class="flex items-start justify-between mb-4">
                            <div class="p-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl">
                                <i class="fas fa-bolt text-white text-2xl"></i>
                            </div>
                            <span class="tag bg-purple-100 text-purple-700">推荐</span>
                        </div>
                        <h4 class="text-xl font-bold text-gray-800 mb-3">灵感速写模式</h4>
                        <p class="text-gray-600 mb-4">AI随机生成创意灵感，实时流式展现，适合寻找灵感或快速体验</p>
                        <ul class="space-y-2 text-sm text-gray-600 mb-6">
                            <li><i class="fas fa-check text-green-500 mr-2"></i>实时流式生成5-10个创意脑洞</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>极简XML格式，传输效率提升70%</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>打字机效果，沉浸式体验</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>快速开始，无需输入</li>
                        </ul>
                        <button onclick="handleQuickGenerate()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            <i class="fas fa-rocket mr-2"></i>开始快速创作
                        </button>
                    </div>
                    
                    <!-- 自定义模式 -->
                    <div class="mode-card bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-8 shadow-lg" data-mode="custom">
                        <div class="flex items-start justify-between mb-4">
                            <div class="p-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl">
                                <i class="fas fa-palette text-white text-2xl"></i>
                            </div>
                            <span class="tag bg-blue-100 text-blue-700">专业</span>
                        </div>
                        <h4 class="text-xl font-bold text-gray-800 mb-3">定制创作模式</h4>
                        <p class="text-gray-600 mb-4">输入你的创意想法，AI根据你的需求定制化生成，完全掌控创作方向</p>
                        <ul class="space-y-2 text-sm text-gray-600 mb-6">
                            <li><i class="fas fa-check text-green-500 mr-2"></i>自由输入创作需求</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>细节参数可调整</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>每步可编辑优化</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>精准定制化生成</li>
                        </ul>
                        <button onclick="handleCustomMode()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            <i class="fas fa-pen-fancy mr-2"></i>开始定制创作
                        </button>
                    </div>
                </div>
            </div>

            <!-- 步骤1: 创意输入（仅用于定制模式，不在进度条显示） -->
            <div id="step1Content" class="content-panel">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-magic text-purple-500 mr-2"></i>定制创作输入
                    </h3>
                    <p class="text-gray-600">输入你的创意想法，AI将基于此生成脑洞</p>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-pen-fancy mr-1"></i>你的创意想法
                        </label>
                        <textarea 
                            id="userCreativeInput"
                            class="w-full p-4 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none" 
                            rows="4" 
                            placeholder="描述你想要的故事类型、主题、角色设定等...&#10;例如：一个关于时间旅行者的故事，主角每次回到过去都会失去一段记忆..."></textarea>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-keyboard mr-1"></i>已输入 <span id="inputCharCount">0</span> 字
                        </div>
                        <button onclick="processCustomInput()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            <i class="fas fa-sparkles mr-2"></i>生成脑洞
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="goBackToModeSelection()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>返回选择
                    </button>
                </div>
            </div>

            <!-- 步骤2: 脑洞生成（流式输出） -->
            <div id="step2Content" class="content-panel">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-brain text-pink-500 mr-2"></i>AI创意脑洞
                    </h3>
                    <p class="text-gray-600">实时流式生成创意脑洞，点击选择你喜欢的创意</p>
                </div>
                
                <!-- 脑洞容器 -->
                <div id="ideasContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 动态生成的脑洞卡片 -->
                </div>
                
                <!-- 底部控制区域（初始隐藏） -->
                <div id="ideasBottomControls" style="display: none;" class="opacity-0 transform translate-y-4 transition-all duration-500">
                    <!-- 优化建议输入区 -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row items-center gap-4">
                            <div class="relative flex-1 w-full">
                                <input 
                                    type="text" 
                                    id="optimizeIdeasInput" 
                                    class="w-full p-3 pl-10 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" 
                                    placeholder="输入优化建议，比如：需要更多科幻元素...">
                                <i class="fas fa-comment-dots text-gray-400 absolute left-3 top-3.5"></i>
                            </div>
                            <button onclick="regenerateIdeas()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium transition-colors flex items-center">
                                <i class="fas fa-sync-alt mr-2"></i>重新生成
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6">
                        <button onclick="prevStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition-all">
                            <i class="fas fa-arrow-left mr-2"></i>返回
                        </button>
                        <button onclick="nextStep()" id="nextToOutlineBtn" class="bg-gray-300 text-gray-500 px-8 py-3 rounded-lg font-medium cursor-not-allowed" disabled>
                            下一步: 生成大纲 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 步骤3: 大纲创作 -->
            <div id="step3Content" class="content-panel">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-list-alt text-blue-500 mr-2"></i>故事大纲
                    </h3>
                    <p class="text-gray-600">基于选择的脑洞生成详细大纲</p>
                </div>
                
                <!-- 大纲展示容器 -->
                <div id="outlineContainer" class="bg-gray-50 rounded-xl p-6">
                    <!-- 动态生成的大纲内容 -->
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="prevStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>返回
                    </button>
                    <button onclick="generateNovel()" id="generateNovelBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg transition-all">
                        下一步: 撰写小说 <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- 步骤4: 小说撰写 -->
            <div id="step4Content" class="content-panel">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-book text-purple-500 mr-2"></i>小说内容
                    </h3>
                    <p class="text-gray-600">AI创作完整的小说内容</p>
                </div>
                
                <!-- 小说内容容器 -->
                <div id="novelContainer" class="bg-gray-50 rounded-xl p-6" style="max-height: 600px; overflow-y: auto;">
                    <!-- 动态生成的小说内容 -->
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="prevStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>返回
                    </button>
                    <button onclick="generateScript()" id="generateScriptBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg transition-all">
                        下一步: 生成脚本 <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- 步骤5: 脚本生成 -->
            <div id="step5Content" class="content-panel">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-film text-orange-500 mr-2"></i>互动脚本
                    </h3>
                    <p class="text-gray-600">将小说转换为互动脚本</p>
                </div>
                
                <!-- 脚本内容容器 -->
                <div id="scriptContainer" class="bg-gray-50 rounded-xl p-6" style="max-height: 600px; overflow-y: auto;">
                    <!-- 动态生成的脚本内容 -->
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="prevStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>返回
                    </button>
                    <button onclick="completeWorkflow()" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg transition-all">
                        <i class="fas fa-check-circle mr-2"></i>完成创作
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 全局变量
        let currentStep = 0;
        let currentMode = null;
        let currentStreamController = null;
        let selectedIdea = null;
        let stepHistory = [0]; // 记录已访问过的步骤
        
        // 步骤信息映射 - 创意输入(step1)不在进度条显示
        const stepInfo = {
            0: { name: '模式选择', icon: 'compass', color: 'indigo', displayIndex: 0 },
            1: { name: '创意输入', icon: 'magic', color: 'purple', displayIndex: null }, // 不显示在进度条
            2: { name: '脑洞生成', icon: 'brain', color: 'pink', displayIndex: 1 },
            3: { name: '大纲创作', icon: 'list-alt', color: 'blue', displayIndex: 2 },
            4: { name: '小说撰写', icon: 'book', color: 'purple', displayIndex: 3 },
            5: { name: '脚本生成', icon: 'film', color: 'orange', displayIndex: 4 }
        };
        
        // 进度条显示的步骤（不包含创意输入）
        const visibleSteps = [0, 2, 3, 4, 5];
        
        // 解析状态管理 - 针对极简格式优化
        const parserState = {
            currentStoryNum: null,
            currentTag: null,
            buffer: '',
            stories: new Map(),
            lastProcessedIndex: 0,
            tagBuffer: ''
        };
        
        // 快速生成模式 - 直接跳到脑洞生成
        function handleQuickGenerate() {
            console.log('快速生成模式 - 直接开始流式生成');
            currentMode = 'quick';
            
            // 显示模式指示器
            const indicator = document.getElementById('modeIndicator');
            indicator.classList.remove('hidden');
            indicator.innerHTML = '<i class="fas fa-bolt mr-1"></i>灵感速写模式';
            
            // 直接跳到脑洞生成步骤
            currentStep = 2;
            updateUI();
            
            // 立即开始流式生成
            setTimeout(() => {
                startStreamingIdeas();
            }, 500);
        }
        
        // 定制模式 - 先到创意输入页
        function handleCustomMode() {
            console.log('定制创作模式');
            currentMode = 'custom';
            
            // 显示模式指示器
            const indicator = document.getElementById('modeIndicator');
            indicator.classList.remove('hidden');
            indicator.innerHTML = '<i class="fas fa-palette mr-1"></i>定制创作模式';
            
            // 跳到创意输入步骤（不显示在进度条）
            currentStep = 1;
            updateUI();
        }
        
        // 返回模式选择
        function goBackToModeSelection() {
            currentStep = 0;
            currentMode = null;
            document.getElementById('modeIndicator').classList.add('hidden');
            updateUI();
        }
        
        // 处理定制输入
        function processCustomInput() {
            const input = document.getElementById('userCreativeInput').value.trim();
            if (!input) {
                alert('请输入你的创意想法');
                return;
            }
            
            // 跳到脑洞生成步骤
            currentStep = 2;
            updateUI();
            
            // 开始流式生成（传入用户输入）
            setTimeout(() => {
                startStreamingIdeas(input);
            }, 500);
        }
        
        // 模拟的脑洞数据
        const mockIdeas = [
            { title: "量子纠缠的爱情", content: "在量子计算机普及的未来，两个程序员发现他们的意识在量子层面产生了纠缠，每当一个人做梦时，另一个人就会进入对方的梦境..." },
            { title: "时间图书馆", content: "一个神秘的图书馆，每本书都连接着不同的时间线。图书管理员必须守护这些书籍，防止有人改写历史..." },
            { title: "AI侦探社", content: "第一家由AI运营的侦探社开业了，他们通过分析大数据来破案，但突然接到了一个连AI都无法理解的神秘案件..." },
            { title: "梦境交易所", content: "在这里，人们可以买卖彼此的梦境，直到有人发现了操控现实的方法..." },
            { title: "最后的手写信", content: "在数字化的未来，一封手写信引发了一场跨越时空的寻找..." }
        ];
        
        // 开始流式生成脑洞（模拟版）
        async function startStreamingIdeas(userInput = null) {
            console.log('🚀 开始模拟流式生成脑洞');
            
            // 如果有用户输入的优化建议，显示在控制台
            if (userInput) {
                console.log('📝 用户优化建议:', userInput);
            }
            
            // 清空容器
            const container = document.getElementById('ideasContainer');
            container.innerHTML = '';
            
            // 显示流式加载动画
            showStreamLoading();
            
            // 模拟延迟后开始生成
            setTimeout(() => {
                hideStreamLoading();
                simulateStreamingOutput();
            }, 1500);
        }
        
        // 重新生成脑洞
        function regenerateIdeas() {
            const optimizeInput = document.getElementById('optimizeIdeasInput');
            const userSuggestion = optimizeInput ? optimizeInput.value.trim() : '';
            
            console.log('🔄 重新生成脑洞');
            
            // 清空已选择的脑洞
            selectedIdea = null;
            
            // 隐藏底部控制区域
            hideBottomControls();
            
            // 禁用下一步按钮
            const nextBtn = document.getElementById('nextToOutlineBtn');
            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                nextBtn.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-emerald-500', 'text-white', 'hover:shadow-lg');
            }
            
            // 重新开始流式生成（传入优化建议）
            startStreamingIdeas(userSuggestion);
        }
        
        // 模拟流式输出
        function simulateStreamingOutput() {
            // 重置解析状态
            resetParserState();
            
            // 构建模拟的XML内容
            let xmlContent = '';
            mockIdeas.forEach((idea, index) => {
                xmlContent += `<s${index + 1}><t>${idea.title}</t><c>${idea.content}</c></s${index + 1}>`;
            });
            
            // 逐字符流式输出
            let currentIndex = 0;
            const outputInterval = setInterval(() => {
                if (currentIndex < xmlContent.length) {
                    // 每次输出1-3个字符，模拟不均匀的流速
                    const chunkSize = Math.floor(Math.random() * 3) + 1;
                    const chunk = xmlContent.substring(currentIndex, currentIndex + chunkSize);
                    
                    // 更新解析状态的lastProcessedIndex
                    const fullContent = xmlContent.substring(0, currentIndex + chunkSize);
                    processStreamContent(fullContent);
                    
                    currentIndex += chunkSize;
                } else {
                    clearInterval(outputInterval);
                    console.log('✅ 模拟流式生成完成');
                    
                    // 显示底部控制区域
                    setTimeout(() => {
                        showBottomControls();
                    }, 500);
                }
            }, 20); // 每20ms输出一次
        }
        
        // [流式处理相关函数保持不变...]
        function resetParserState() {
            parserState.currentStoryNum = null;
            parserState.currentTag = null;
            parserState.buffer = '';
            parserState.stories.clear();
            parserState.lastProcessedIndex = 0;
            parserState.tagBuffer = '';
        }
        
        function processStreamContent(fullContent) {
            const newContent = fullContent.substring(parserState.lastProcessedIndex);
            if (!newContent) return;
            
            for (let i = 0; i < newContent.length; i++) {
                const char = newContent[i];
                parserState.buffer += char;
                parserState.tagBuffer += char;
                
                if (parserState.tagBuffer.length > 20) {
                    parserState.tagBuffer = parserState.tagBuffer.substring(1);
                }
                
                detectAndProcessSimplifiedXML();
            }
            
            parserState.lastProcessedIndex = fullContent.length;
        }
        
        function detectAndProcessSimplifiedXML() {
            const buffer = parserState.buffer;
            const tagBuffer = parserState.tagBuffer;
            
            const storyStartMatch = tagBuffer.match(/<s(\d+)>$/);
            if (storyStartMatch) {
                const storyNum = storyStartMatch[1];
                console.log(`📖 检测到story ${storyNum} 开始`);
                
                parserState.currentStoryNum = storyNum;
                parserState.currentTag = null;
                
                parserState.stories.set(storyNum, {
                    number: storyNum,
                    title: '',
                    content: '',
                    cardCreated: false,
                    titleStarted: false,
                    contentStarted: false,
                    titleComplete: false,
                    contentComplete: false
                });
                
                createEmptyStoryCard(storyNum);
                parserState.buffer = '';
                return;
            }
            
            if (parserState.currentStoryNum && tagBuffer.endsWith('<t>')) {
                console.log(`📝 Story ${parserState.currentStoryNum} 标题开始`);
                const story = parserState.stories.get(parserState.currentStoryNum);
                if (story) {
                    story.titleStarted = true;
                    parserState.currentTag = 't';
                    parserState.buffer = '';
                }
                return;
            }
            
            if (parserState.currentTag === 't' && parserState.currentStoryNum) {
                const story = parserState.stories.get(parserState.currentStoryNum);
                if (story && story.titleStarted && !story.titleComplete) {
                    if (buffer.includes('</t>')) {
                        const titleContent = buffer.substring(0, buffer.indexOf('</t>'));
                        if (titleContent.length > story.title.length) {
                            const newChars = titleContent.substring(story.title.length);
                            appendToTitle(story.number, newChars);
                            story.title = titleContent;
                        }
                        story.titleComplete = true;
                        parserState.currentTag = null;
                        parserState.buffer = '';
                        console.log(`✅ Story ${story.number} 标题完成: ${story.title}`);
                    } else {
                        if (buffer.length > story.title.length && !buffer.includes('<')) {
                            const newChars = buffer.substring(story.title.length);
                            appendToTitle(story.number, newChars);
                            story.title = buffer;
                        }
                    }
                }
            }
            
            if (parserState.currentStoryNum && tagBuffer.endsWith('<c>')) {
                console.log(`📄 Story ${parserState.currentStoryNum} 内容开始`);
                const story = parserState.stories.get(parserState.currentStoryNum);
                if (story) {
                    story.contentStarted = true;
                    parserState.currentTag = 'c';
                    parserState.buffer = '';
                    removeTitleCursor(story.number);
                }
                return;
            }
            
            if (parserState.currentTag === 'c' && parserState.currentStoryNum) {
                const story = parserState.stories.get(parserState.currentStoryNum);
                if (story && story.contentStarted && !story.contentComplete) {
                    if (buffer.includes('</c>')) {
                        const content = buffer.substring(0, buffer.indexOf('</c>'));
                        if (content.length > story.content.length) {
                            const newChars = content.substring(story.content.length);
                            appendToContent(story.number, newChars);
                            story.content = content;
                        }
                        story.contentComplete = true;
                        parserState.currentTag = null;
                        parserState.buffer = '';
                        console.log(`✅ Story ${story.number} 内容完成`);
                    } else {
                        if (buffer.length > story.content.length && !buffer.includes('<')) {
                            const newChars = buffer.substring(story.content.length);
                            appendToContent(story.number, newChars);
                            story.content = buffer;
                        }
                    }
                }
            }
            
            const storyEndMatch = tagBuffer.match(/<\/s(\d+)>$/);
            if (storyEndMatch) {
                const storyNum = storyEndMatch[1];
                if (storyNum === parserState.currentStoryNum) {
                    const story = parserState.stories.get(storyNum);
                    console.log(`✅ Story ${storyNum} 完全结束`);
                    finalizeStoryCard(storyNum);
                    parserState.currentStoryNum = null;
                    parserState.currentTag = null;
                    parserState.buffer = '';
                }
            }
        }
        
        // [卡片相关函数保持不变...]
        function createEmptyStoryCard(storyNum) {
            const container = document.getElementById('ideasContainer');
            if (!container) return;
            
            const card = document.createElement('div');
            card.id = `idea-card-${storyNum}`;
            card.className = 'idea-card stream-card-enter skeleton-card';
            card.innerHTML = `
                <div class="idea-number">${storyNum}</div>
                <h3 class="idea-title skeleton-text">
                    <span class="title-content editable" data-type="idea-title" data-id="${storyNum}"></span>
                    <i class="fas fa-edit edit-icon"></i>
                    <span class="typewriter-cursor">|</span>
                    <span class="edit-controls">
                        <button class="save-btn" onclick="saveEditBtn(this, event); return false;"><i class="fas fa-check"></i> 保存</button>
                        <button class="cancel-btn" onclick="cancelEditBtn(this, event); return false;"><i class="fas fa-times"></i> 取消</button>
                    </span>
                </h3>
                <p class="idea-content skeleton-text">
                    <span class="content-text editable" data-type="idea-content" data-id="${storyNum}"></span>
                    <i class="fas fa-edit edit-icon"></i>
                    <span class="typewriter-cursor">|</span>
                    <span class="edit-controls">
                        <button class="save-btn" onclick="saveEditBtn(this, event); return false;"><i class="fas fa-check"></i> 保存</button>
                        <button class="cancel-btn" onclick="cancelEditBtn(this, event); return false;"><i class="fas fa-times"></i> 取消</button>
                    </span>
                </p>
                <button class="select-idea-btn" disabled style="opacity: 0.3">
                    加载中...
                </button>
            `;
            
            container.appendChild(card);
            
            setTimeout(() => {
                card.classList.add('stream-card-visible');
            }, 50);
        }
        
        function appendToTitle(storyNum, newChars) {
            const card = document.getElementById(`idea-card-${storyNum}`);
            if (!card) return;
            
            const titleEl = card.querySelector('.idea-title');
            if (!titleEl) return;
            
            titleEl.classList.remove('skeleton-text');
            
            const titleContent = titleEl.querySelector('.title-content');
            if (!titleContent) return;
            
            for (let i = 0; i < newChars.length; i++) {
                ((index, char) => {
                    setTimeout(() => {
                        titleContent.textContent += char;
                    }, index * 15);
                })(i, newChars[i]);
            }
        }
        
        function removeTitleCursor(storyNum) {
            const card = document.getElementById(`idea-card-${storyNum}`);
            if (!card) return;
            
            const titleEl = card.querySelector('.idea-title');
            if (!titleEl) return;
            
            const titleCursor = titleEl.querySelector('.typewriter-cursor');
            if (titleCursor) {
                titleCursor.remove();
                console.log(`🔤 移除Story ${storyNum}标题光标`);
            }
        }
        
        function appendToContent(storyNum, newChars) {
            const card = document.getElementById(`idea-card-${storyNum}`);
            if (!card) return;
            
            const contentEl = card.querySelector('.idea-content');
            if (!contentEl) return;
            
            contentEl.classList.remove('skeleton-text');
            
            const contentText = contentEl.querySelector('.content-text');
            if (!contentText) return;
            
            for (let i = 0; i < newChars.length; i++) {
                ((index, char) => {
                    setTimeout(() => {
                        contentText.textContent += char;
                    }, index * 15);
                })(i, newChars[i]);
            }
        }
        
        function finalizeStoryCard(storyNum) {
            const card = document.getElementById(`idea-card-${storyNum}`);
            if (!card) return;
            
            card.classList.remove('skeleton-card');
            
            setTimeout(() => {
                const cursors = card.querySelectorAll('.typewriter-cursor');
                cursors.forEach(cursor => cursor.remove());
            }, 500);
            
            const btn = card.querySelector('.select-idea-btn');
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.textContent = '选择这个脑洞';
                btn.addEventListener('click', () => {
                    selectIdea(storyNum);
                });
            }
            
            card.classList.add('card-complete');
            
            // 初始化编辑功能
            initEditableContent();
            
            card.addEventListener('click', function(e) {
                // 如果点击的不是可编辑元素，则选择脑洞
                if (!e.target.classList.contains('editable')) {
                    selectIdea(storyNum);
                }
            });
        }
        
        // 选择脑洞
        function selectIdea(storyNum) {
            console.log(`选择脑洞: ${storyNum}`);
            
            // 如果已经选中相同的卡片，直接返回
            if (selectedIdea === storyNum) return;
            
            // 只移除其他卡片的选中状态
            document.querySelectorAll('.idea-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.getElementById(`idea-card-${storyNum}`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedIdea = storyNum;
                
                const nextBtn = document.getElementById('nextToOutlineBtn');
                if (nextBtn) {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    nextBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-500', 'text-white', 'hover:shadow-lg');
                }
                
                // 只更新进度条相关的UI，不触发内容面板切换
                updateProgressOnly();
            }
        }
        
        // 显示流式加载动画
        function showStreamLoading() {
            const container = document.getElementById('ideasContainer');
            if (!container) return;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'streamLoading';
            loadingDiv.className = 'col-span-full stream-loading';
            loadingDiv.innerHTML = `
                <div class="stream-loading-animation">
                    <div class="stream-dot"></div>
                    <div class="stream-dot"></div>
                    <div class="stream-dot"></div>
                </div>
                <p class="stream-loading-text">AI正在生成创意脑洞...</p>
                <p class="text-sm text-gray-500 mt-2">使用极简XML格式，传输效率提升70%</p>
            `;
            container.appendChild(loadingDiv);
        }
        
        // 隐藏流式加载动画
        function hideStreamLoading() {
            const loadingDiv = document.getElementById('streamLoading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // 跳转到指定步骤
        function goToStep(step) {
            // 检查步骤是否可访问
            if (!canAccessStep(step)) {
                console.log(`⚠️ 步骤 ${step} 还不能访问`);
                return;
            }
            
            currentStep = step;
            
            // 添加到历史记录
            if (!stepHistory.includes(step)) {
                stepHistory.push(step);
            }
            
            updateUI();
            
            // 如果跳转到大纲步骤且还没有生成大纲，自动生成
            if (step === 3 && !document.getElementById('chaptersContainer')?.children.length) {
                setTimeout(() => {
                    generateOutline();
                }, 500);
            }
            // 如果跳转到小说步骤且还没有生成小说，自动生成
            if (step === 4 && !document.getElementById('novelText')?.textContent) {
                setTimeout(() => {
                    generateNovel();
                }, 500);
            }
            // 如果跳转到脚本步骤且还没有生成脚本，自动生成
            if (step === 5 && !document.getElementById('scenesContainer')?.children.length) {
                setTimeout(() => {
                    generateScript();
                }, 500);
            }
        }
        
        // 检查步骤是否可访问
        function canAccessStep(step) {
            // 模式选择始终可访问
            if (step === 0) return true;
            
            // 创意输入需要选择了定制模式
            if (step === 1) return currentMode === 'custom';
            
            // 脑洞生成需要选择了模式
            if (step === 2) return currentMode !== null;
            
            // 大纲创作需要选择了脑洞
            if (step === 3) return selectedIdea !== null;
            
            // 小说撰写需要生成了大纲
            if (step === 4) return stepHistory.includes(3);
            
            // 脚本生成需要生成了小说
            if (step === 5) return stepHistory.includes(4);
            
            return false;
        }
        
        // 切换到下一步
        function nextStep() {
            // 找到下一个有效步骤
            if (currentStep === 0) {
                currentStep = 2; // 从模式选择跳到脑洞生成
            } else if (currentStep === 2) {
                // 从脑洞生成到大纲创作
                currentStep = 3;
                // 自动生成大纲
                setTimeout(() => {
                    generateOutline();
                }, 500);
            } else if (currentStep < 5) {
                currentStep++;
            }
            
            // 添加到历史记录
            if (!stepHistory.includes(currentStep)) {
                stepHistory.push(currentStep);
            }
            
            updateUI();
        }
        
        // 返回上一步
        function prevStep() {
            if (currentStep === 2) {
                // 从脑洞生成返回
                if (currentMode === 'quick') {
                    // 快速模式返回到模式选择
                    currentStep = 0;
                    currentMode = null;
                    document.getElementById('modeIndicator').classList.add('hidden');
                } else if (currentMode === 'custom') {
                    // 定制模式返回到创意输入
                    currentStep = 1;
                }
            } else if (currentStep > 2) {
                currentStep--;
            }
            updateUI();
        }
        
        // 只更新进度条相关UI（不切换内容面板）
        function updateProgressOnly() {
            // 更新步骤节点状态
            document.querySelectorAll('.step-node').forEach((node) => {
                const nodeStep = parseInt(node.dataset.step);
                
                // 检查是否可访问
                const accessible = canAccessStep(nodeStep);
                
                node.classList.remove('cursor-pointer', 'cursor-not-allowed', 'opacity-50');
                
                if (accessible) {
                    node.classList.add('cursor-pointer');
                    node.classList.remove('opacity-50');
                    node.onclick = () => goToStep(nodeStep);
                } else {
                    node.classList.add('cursor-not-allowed', 'opacity-50');
                    node.onclick = null;
                }
            });
        }
        
        // 更新界面
        function updateUI() {
            // 计算进度（基于可见步骤）
            let progressIndex = 0;
            if (currentStep === 0) {
                progressIndex = 0;
            } else if (currentStep === 1) {
                // 创意输入时，保持模式选择高亮
                progressIndex = 0;
            } else {
                progressIndex = visibleSteps.indexOf(currentStep);
            }
            
            // 计算进度（已删除进度条，此计算可保留用于其他逻辑）
            const progress = (progressIndex / (visibleSteps.length - 1)) * 100;
            
            // 更新步骤节点状态（只更新进度条上显示的节点）
            document.querySelectorAll('.step-node').forEach((node) => {
                const nodeStep = parseInt(node.dataset.step);
                const nodeDisplayIndex = parseInt(node.dataset.displayIndex);
                
                node.classList.remove('active', 'completed', 'cursor-pointer', 'cursor-not-allowed', 'opacity-50');
                
                // 检查是否可访问
                const accessible = canAccessStep(nodeStep);
                
                if (accessible) {
                    node.classList.add('cursor-pointer');
                    node.classList.remove('opacity-50');
                    node.onclick = () => goToStep(nodeStep);
                } else {
                    node.classList.add('cursor-not-allowed', 'opacity-50');
                    node.onclick = null;
                }
                
                if (nodeDisplayIndex < progressIndex) {
                    node.classList.add('completed');
                    node.querySelector('.step-icon').classList.remove('text-gray-400');
                } else if (nodeDisplayIndex === progressIndex) {
                    // 当前步骤始终显示active（包括创意输入时显示模式选择为active）
                    node.classList.add('active');
                    node.querySelector('.step-icon').classList.remove('text-gray-400');
                } else {
                    node.querySelector('.step-icon').classList.add('text-gray-400');
                }
            });
            
            // 更新连接线状态
            document.querySelectorAll('.progress-line').forEach((line, index) => {
                line.classList.remove('active', 'completed');
                if (index < progressIndex) {
                    line.classList.add('completed');
                } else if (index === progressIndex) {
                    line.classList.add('active');
                }
            });
            
            // 更新步骤标签颜色和可访问性
            const stepLabels = document.querySelectorAll('.step-label');
            stepLabels.forEach((label) => {
                const labelStep = parseInt(label.dataset.step);
                const labelIndex = visibleSteps.indexOf(labelStep);
                
                label.classList.remove('text-green-600', 'text-gray-400', 'cursor-pointer', 'cursor-not-allowed');
                
                // 检查是否可访问
                const accessible = canAccessStep(labelStep);
                
                if (accessible) {
                    label.disabled = false;
                    label.classList.add('cursor-pointer');
                    if (labelIndex <= progressIndex) {
                        label.classList.add('text-green-600');
                        label.classList.remove('text-gray-400');
                    } else {
                        label.classList.add('text-gray-400');
                    }
                } else {
                    label.disabled = true;
                    label.classList.add('cursor-not-allowed', 'text-gray-400');
                }
            });
            
            // 切换内容面板 - 只在步骤改变时切换
            const currentPanel = document.getElementById(`step${currentStep}Content`);
            const isAlreadyActive = currentPanel && currentPanel.classList.contains('active');
            
            if (!isAlreadyActive) {
                document.querySelectorAll('.content-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                
                setTimeout(() => {
                    if (currentPanel) {
                        currentPanel.classList.add('active');
                    }
                }, 100);
            }
        }
        
        // 模拟的大纲数据
        const mockOutline = {
            title: "量子纠缠的爱情",
            genre: "科幻爱情",
            chapters: [
                {
                    number: "第一章",
                    title: "量子实验室的邂逅",
                    summary: "两位量子物理学家在进行纠缠态实验时，意外发现他们的意识可以通过量子纠缠进行连接..."
                },
                {
                    number: "第二章",
                    title: "梦境的交织",
                    summary: "当一个人入睡时，另一个人便会进入对方的梦境，他们开始在梦中探索彼此的内心世界..."
                },
                {
                    number: "第三章",
                    title: "现实的距离",
                    summary: "尽管意识相连，但他们在现实中相隔千里，必须面对物理距离带来的挑战..."
                },
                {
                    number: "第四章",
                    title: "量子崩塌的危机",
                    summary: "实验出现意外，量子纠缠开始不稳定，他们可能永远失去这种连接..."
                },
                {
                    number: "第五章",
                    title: "跨越时空的重逢",
                    summary: "通过最后的努力，他们找到了在现实中相遇的方法，量子纠缠成为了永恒的纽带..."
                }
            ]
        };
        
        // 模拟的小说内容
        const mockNovel = {
            title: "量子纠缠的爱情",
            content: `第一章　量子实验室的邂逅

深夜的量子物理实验室里，只有机器的嗡鸣声和键盘的敲击声。李墨凝视着屏幕上跳动的数据，眉头紧锁。

"又是一组异常数据。"她自言自语道，揉了揉疲惫的眼睛。

就在这时，实验室的门被推开了。"还在加班？"一个温和的声音传来。

她抬起头，看到了新来的研究员陈宇。月光透过窗户洒在他身上，让他整个人看起来有些不真实。

"量子纠缠态的实验数据出现了一些...有趣的现象。"李墨指着屏幕说道。

陈宇走近，当他的手无意中碰到李墨的手时，两人同时感到一阵奇异的眩晕。屏幕上的数据突然剧烈波动起来，仿佛两个量子系统产生了前所未有的纠缠...

第二章　梦境的交织

那天晚上，李墨做了一个奇怪的梦。

她站在一片星空下，周围是无边的宇宙。突然，她听到了熟悉的声音："你也在这里？"

转过身，她看到了陈宇，同样一脸惊讶地看着她。

"这是梦吗？"李墨问道。

"如果是梦，为什么我们会在同一个梦里？"陈宇回答。

他们很快发现，自从实验室的那次接触后，每当一个人入睡，另一个人就会进入对方的梦境。在梦中，他们可以分享记忆、情感，甚至思想...

（后续章节内容省略...）`
        };
        
        // 模拟的脚本内容
        const mockScript = {
            title: "量子纠缠的爱情 - 互动脚本",
            scenes: [
                {
                    scene: "场景1",
                    location: "量子实验室 - 深夜",
                    description: "【灯光】昏暗，只有电脑屏幕的光芒\n【音效】机器嗡鸣声，键盘敲击声",
                    dialogue: [
                        { character: "李墨", action: "（盯着屏幕，自言自语）", line: "又是一组异常数据..." },
                        { character: "陈宇", action: "（推门而入）", line: "还在加班？" },
                        { character: "互动选择", options: ["A. 继续研究数据", "B. 邀请陈宇一起查看", "C. 准备离开"] }
                    ]
                },
                {
                    scene: "场景2",
                    location: "梦境空间 - 星空下",
                    description: "【视觉效果】璀璨星空，漂浮感\n【音效】空灵的背景音乐",
                    dialogue: [
                        { character: "李墨", action: "（环顾四周）", line: "这是哪里？" },
                        { character: "陈宇", action: "（出现）", line: "你也在这里？" },
                        { character: "系统提示", text: "玩家可以选择探索梦境的不同区域" }
                    ]
                }
            ]
        };
        
        // 生成大纲（流式输出）
        function generateOutline() {
            const container = document.getElementById('outlineContainer');
            if (!container) return;
            
            // 先显示加载动画
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="stream-loading-animation inline-flex">
                        <div class="stream-dot"></div>
                        <div class="stream-dot"></div>
                        <div class="stream-dot"></div>
                    </div>
                    <p class="text-gray-600 mt-4">AI正在构思故事大纲...</p>
                </div>
            `;
            
            // 延迟后开始流式生成
            setTimeout(() => {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">
                                <span id="outlineTitle" class="editable" data-type="outline-title" data-id="1"></span>
                                <i class="fas fa-edit edit-icon"></i>
                                <span class="typewriter-cursor">|</span>
                                <span class="edit-controls">
                                    <button class="save-btn" onclick="saveEditBtn(this, event); return false;"><i class="fas fa-check"></i> 保存</button>
                                    <button class="cancel-btn" onclick="cancelEditBtn(this, event); return false;"><i class="fas fa-times"></i> 取消</button>
                                </span>
                            </h4>
                            <p class="text-sm text-gray-600">
                                类型: <span id="outlineGenre" class="editable" data-type="outline-genre" data-id="1"></span>
                                <i class="fas fa-edit edit-icon"></i>
                                <span class="edit-controls">
                                    <button class="save-btn" onclick="saveEditBtn(this, event); return false;"><i class="fas fa-check"></i> 保存</button>
                                    <button class="cancel-btn" onclick="cancelEditBtn(this, event); return false;"><i class="fas fa-times"></i> 取消</button>
                                </span>
                            </p>
                        </div>
                        
                        <div id="chaptersContainer" class="space-y-4">
                            <!-- 章节将动态添加 -->
                        </div>
                    </div>
                `;
                
                // 流式输出标题
                typewriterEffect('outlineTitle', mockOutline.title, 30, () => {
                    // 输出类型
                    typewriterEffect('outlineGenre', mockOutline.genre, 30, () => {
                        // 移除标题光标
                        const titleCursor = document.querySelector('#outlineTitle').parentElement.querySelector('.typewriter-cursor');
                        if (titleCursor) titleCursor.remove();
                        
                        // 开始流式生成章节
                        streamChapters();
                    });
                });
            }, 1500);
        }
        
        // 流式生成章节
        function streamChapters() {
            const container = document.getElementById('chaptersContainer');
            if (!container) return;
            
            let chapterIndex = 0;
            
            function addChapter() {
                if (chapterIndex >= mockOutline.chapters.length) {
                    // 所有章节生成完成
                    console.log('✅ 大纲生成完成');
                    return;
                }
                
                const chapter = mockOutline.chapters[chapterIndex];
                
                // 创建章节卡片（初始为骨架屏）
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'bg-white rounded-lg p-4 hover:shadow-md transition-all cursor-pointer opacity-0';
                chapterDiv.innerHTML = `
                    <div class="flex items-start">
                        <span class="text-blue-500 font-bold mr-3">${chapter.number}</span>
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800 mb-1">
                                <span id="chapterTitle${chapterIndex}" class="editable" data-type="chapter-title" data-id="${chapterIndex + 1}"></span>
                                <i class="fas fa-edit edit-icon"></i>
                                <span class="typewriter-cursor">|</span>
                                <span class="edit-controls">
                                    <button class="save-btn" onclick="saveEditBtn(this, event); return false;"><i class="fas fa-check"></i></button>
                                    <button class="cancel-btn" onclick="cancelEditBtn(this, event); return false;"><i class="fas fa-times"></i></button>
                                </span>
                            </h5>
                            <p class="text-sm text-gray-600">
                                <span id="chapterSummary${chapterIndex}" class="editable" data-type="chapter-summary" data-id="${chapterIndex + 1}"></span>
                                <i class="fas fa-edit edit-icon"></i>
                                <span class="typewriter-cursor" style="display: none;">|</span>
                                <span class="edit-controls">
                                    <button class="save-btn" onclick="saveEditBtn(this, event); return false;"><i class="fas fa-check"></i></button>
                                    <button class="cancel-btn" onclick="cancelEditBtn(this, event); return false;"><i class="fas fa-times"></i></button>
                                </span>
                            </p>
                        </div>
                    </div>
                `;
                
                container.appendChild(chapterDiv);
                
                // 淡入动画
                setTimeout(() => {
                    chapterDiv.classList.remove('opacity-0');
                    chapterDiv.classList.add('stream-card-enter', 'stream-card-visible');
                }, 50);
                
                // 流式输出章节标题
                setTimeout(() => {
                    typewriterEffect(`chapterTitle${chapterIndex}`, chapter.title, 20, () => {
                        // 移除标题光标，显示内容光标
                        const titleCursor = document.querySelector(`#chapterTitle${chapterIndex}`).parentElement.querySelector('.typewriter-cursor');
                        if (titleCursor) titleCursor.style.display = 'none';
                        
                        const summaryCursor = document.querySelector(`#chapterSummary${chapterIndex}`).parentElement.querySelector('.typewriter-cursor');
                        if (summaryCursor) summaryCursor.style.display = 'inline-block';
                        
                        // 流式输出章节摘要
                        typewriterEffect(`chapterSummary${chapterIndex}`, chapter.summary, 15, () => {
                            // 移除内容光标
                            const cursor = document.querySelector(`#chapterSummary${chapterIndex}`).parentElement.querySelector('.typewriter-cursor');
                            if (cursor) cursor.remove();
                            
                            // 处理下一个章节
                            chapterIndex++;
                            
                            // 初始化编辑功能
                            initEditableContent();
                            
                            setTimeout(addChapter, 300); // 章节间延迟
                        });
                    });
                }, 200);
            }
            
            // 开始添加第一个章节
            addChapter();
        }
        
        // 通用打字机效果函数
        function typewriterEffect(elementId, text, speed = 20, callback) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let charIndex = 0;
            const typeInterval = setInterval(() => {
                if (charIndex < text.length) {
                    element.textContent += text[charIndex];
                    charIndex++;
                } else {
                    clearInterval(typeInterval);
                    if (callback) callback();
                }
            }, speed);
        }
        
        // 生成小说
        function generateNovel() {
            currentStep = 4;
            if (!stepHistory.includes(4)) {
                stepHistory.push(4);
            }
            updateUI();
            
            const container = document.getElementById('novelContainer');
            if (!container) return;
            
            // 先显示加载动画
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="stream-loading-animation inline-flex">
                        <div class="stream-dot"></div>
                        <div class="stream-dot"></div>
                        <div class="stream-dot"></div>
                    </div>
                    <p class="text-gray-600 mt-4">AI正在创作小说...</p>
                </div>
            `;
            
            // 模拟延迟后显示小说内容（打字机效果）
            setTimeout(() => {
                container.innerHTML = `
                    <div class="prose max-w-none">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">${mockNovel.title}</h2>
                        <div id="novelText" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
                        <span class="typewriter-cursor">|</span>
                    </div>
                `;
                
                // 打字机效果显示小说内容
                const novelText = document.getElementById('novelText');
                let charIndex = 0;
                const typeInterval = setInterval(() => {
                    if (charIndex < mockNovel.content.length) {
                        novelText.textContent += mockNovel.content[charIndex];
                        charIndex++;
                        container.scrollTop = container.scrollHeight;
                    } else {
                        clearInterval(typeInterval);
                        // 移除光标
                        const cursor = container.querySelector('.typewriter-cursor');
                        if (cursor) cursor.remove();
                    }
                }, 10); // 快速打字效果
            }, 2000);
        }
        
        // 生成脚本（流式输出）
        function generateScript() {
            currentStep = 5;
            if (!stepHistory.includes(5)) {
                stepHistory.push(5);
            }
            updateUI();
            
            const container = document.getElementById('scriptContainer');
            if (!container) return;
            
            // 先显示加载动画
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="stream-loading-animation inline-flex">
                        <div class="stream-dot"></div>
                        <div class="stream-dot"></div>
                        <div class="stream-dot"></div>
                    </div>
                    <p class="text-gray-600 mt-4">AI正在生成互动脚本...</p>
                </div>
            `;
            
            // 延迟后开始流式生成
            setTimeout(() => {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg p-4 border-l-4 border-orange-500">
                            <h4 class="text-xl font-bold text-gray-800">
                                <span id="scriptTitle"></span>
                                <span class="typewriter-cursor">|</span>
                            </h4>
                        </div>
                        
                        <div id="scenesContainer" class="space-y-6">
                            <!-- 场景将动态添加 -->
                        </div>
                    </div>
                `;
                
                // 流式输出标题
                typewriterEffect('scriptTitle', mockScript.title, 30, () => {
                    // 移除标题光标
                    const titleCursor = document.querySelector('#scriptTitle').parentElement.querySelector('.typewriter-cursor');
                    if (titleCursor) titleCursor.remove();
                    
                    // 开始流式生成场景
                    streamScenes();
                });
            }, 1500);
        }
        
        // 流式生成场景
        function streamScenes() {
            const container = document.getElementById('scenesContainer');
            if (!container) return;
            
            let sceneIndex = 0;
            
            function addScene() {
                if (sceneIndex >= mockScript.scenes.length) {
                    console.log('✅ 脚本生成完成');
                    return;
                }
                
                const scene = mockScript.scenes[sceneIndex];
                
                // 创建场景容器
                const sceneDiv = document.createElement('div');
                sceneDiv.className = 'bg-white rounded-lg p-6 shadow-sm opacity-0';
                sceneDiv.innerHTML = `
                    <div class="mb-4">
                        <h5 class="text-lg font-bold text-gray-800">
                            <span id="sceneTitle${sceneIndex}"></span>
                            <span class="typewriter-cursor">|</span>
                        </h5>
                        <p class="text-sm text-gray-600 mt-1">
                            地点: <span id="sceneLocation${sceneIndex}"></span>
                        </p>
                        <div class="mt-2 p-3 bg-gray-50 rounded text-sm text-gray-700">
                            <span id="sceneDescription${sceneIndex}"></span>
                        </div>
                    </div>
                    
                    <div id="dialogueContainer${sceneIndex}" class="space-y-3">
                        <!-- 对话将动态添加 -->
                    </div>
                `;
                
                container.appendChild(sceneDiv);
                
                // 淡入动画
                setTimeout(() => {
                    sceneDiv.classList.remove('opacity-0');
                    sceneDiv.classList.add('stream-card-enter', 'stream-card-visible');
                }, 50);
                
                // 流式输出场景信息
                setTimeout(() => {
                    // 输出场景标题
                    typewriterEffect(`sceneTitle${sceneIndex}`, scene.scene, 25, () => {
                        const titleCursor = document.querySelector(`#sceneTitle${sceneIndex}`).parentElement.querySelector('.typewriter-cursor');
                        if (titleCursor) titleCursor.remove();
                        
                        // 输出地点
                        typewriterEffect(`sceneLocation${sceneIndex}`, scene.location, 20, () => {
                            // 输出描述
                            typewriterEffect(`sceneDescription${sceneIndex}`, scene.description.replace(/\\n/g, '\n'), 15, () => {
                                // 开始流式生成对话
                                streamDialogue(scene, sceneIndex, () => {
                                    // 处理下一个场景
                                    sceneIndex++;
                                    setTimeout(addScene, 500);
                                });
                            });
                        });
                    });
                }, 200);
            }
            
            // 开始添加第一个场景
            addScene();
        }
        
        // 流式生成对话
        function streamDialogue(scene, sceneIndex, callback) {
            const container = document.getElementById(`dialogueContainer${sceneIndex}`);
            if (!container) return;
            
            let dialogueIndex = 0;
            
            function addDialogue() {
                if (dialogueIndex >= scene.dialogue.length) {
                    if (callback) callback();
                    return;
                }
                
                const d = scene.dialogue[dialogueIndex];
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'opacity-0';
                
                if (d.character === '互动选择') {
                    dialogueDiv.className += ' bg-blue-50 rounded-lg p-4';
                    dialogueDiv.innerHTML = `
                        <p class="font-semibold text-blue-700 mb-2">玩家选择:</p>
                        <div id="options${sceneIndex}_${dialogueIndex}" class="space-y-2">
                            <!-- 选项将动态添加 -->
                        </div>
                    `;
                    
                    container.appendChild(dialogueDiv);
                    
                    setTimeout(() => {
                        dialogueDiv.classList.remove('opacity-0');
                        dialogueDiv.classList.add('stream-card-enter', 'stream-card-visible');
                        
                        // 逐个添加选项
                        const optionsContainer = document.getElementById(`options${sceneIndex}_${dialogueIndex}`);
                        d.options.forEach((opt, optIndex) => {
                            setTimeout(() => {
                                const optionBtn = document.createElement('button');
                                optionBtn.className = 'w-full text-left px-4 py-2 bg-white rounded hover:bg-blue-100 transition-all opacity-0';
                                optionBtn.textContent = opt;
                                optionsContainer.appendChild(optionBtn);
                                
                                setTimeout(() => {
                                    optionBtn.classList.remove('opacity-0');
                                    optionBtn.classList.add('stream-card-enter', 'stream-card-visible');
                                }, 50);
                            }, optIndex * 150);
                        });
                        
                        setTimeout(() => {
                            dialogueIndex++;
                            addDialogue();
                        }, d.options.length * 150 + 200);
                    }, 50);
                    
                } else if (d.character === '系统提示') {
                    dialogueDiv.className += ' bg-yellow-50 rounded p-3 text-sm text-yellow-800';
                    dialogueDiv.innerHTML = `
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="systemText${sceneIndex}_${dialogueIndex}"></span>
                    `;
                    
                    container.appendChild(dialogueDiv);
                    
                    setTimeout(() => {
                        dialogueDiv.classList.remove('opacity-0');
                        dialogueDiv.classList.add('stream-card-enter', 'stream-card-visible');
                        
                        typewriterEffect(`systemText${sceneIndex}_${dialogueIndex}`, d.text, 20, () => {
                            dialogueIndex++;
                            setTimeout(addDialogue, 300);
                        });
                    }, 50);
                    
                } else {
                    dialogueDiv.className += ' flex items-start space-x-3';
                    dialogueDiv.innerHTML = `
                        <span class="font-semibold text-gray-700 min-w-[80px]">${d.character}:</span>
                        <div class="flex-1">
                            ${d.action ? `<span class="text-gray-500 italic">${d.action}</span>` : ''}
                            <p class="text-gray-800">
                                <span id="dialogueLine${sceneIndex}_${dialogueIndex}"></span>
                                <span class="typewriter-cursor">|</span>
                            </p>
                        </div>
                    `;
                    
                    container.appendChild(dialogueDiv);
                    
                    setTimeout(() => {
                        dialogueDiv.classList.remove('opacity-0');
                        dialogueDiv.classList.add('stream-card-enter', 'stream-card-visible');
                        
                        typewriterEffect(`dialogueLine${sceneIndex}_${dialogueIndex}`, d.line, 20, () => {
                            const cursor = document.querySelector(`#dialogueLine${sceneIndex}_${dialogueIndex}`).parentElement.querySelector('.typewriter-cursor');
                            if (cursor) cursor.remove();
                            
                            dialogueIndex++;
                            setTimeout(addDialogue, 300);
                        });
                    }, 50);
                }
            }
            
            // 开始添加第一个对话
            setTimeout(addDialogue, 300);
        }
        
        // 完成工作流
        function completeWorkflow() {
            // 显示完成动画
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md mx-4 transform scale-95 opacity-0 transition-all duration-300" id="successModal">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-green-600 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">创作完成！</h3>
                        <p class="text-gray-600 mb-6">您的AI小说创作已经完成，包含完整的故事大纲、小说内容和互动脚本。</p>
                        <div class="space-y-3">
                            <button onclick="downloadAll()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                                <i class="fas fa-download mr-2"></i>下载所有内容
                            </button>
                            <button onclick="startNewCreation()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                <i class="fas fa-plus mr-2"></i>开始新创作
                            </button>
                            <button onclick="closeModal()" class="w-full text-gray-500 py-2 hover:text-gray-700 transition-all">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 触发动画
            setTimeout(() => {
                const modalContent = document.getElementById('successModal');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 100);
        }
        
        // 下载所有内容（模拟）
        function downloadAll() {
            alert('下载功能开发中...');
        }
        
        // 开始新创作
        function startNewCreation() {
            location.reload();
        }
        
        // 关闭模态框
        function closeModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }
        
        // 字数统计功能
        const userInput = document.getElementById('userCreativeInput');
        if (userInput) {
            userInput.addEventListener('input', function() {
                document.getElementById('inputCharCount').textContent = this.value.length;
            });
        }
        
        // 编辑功能相关函数
        let editingElements = new Map(); // 存储正在编辑的元素和原始内容
        
        // 初始化可编辑内容
        function initEditableContent() {
            // 只为尚未绑定事件的编辑图标添加点击事件
            const editIcons = document.querySelectorAll('.edit-icon:not([data-initialized])');
            editIcons.forEach(icon => {
                icon.addEventListener('click', handleEditIconClick);
                icon.setAttribute('data-initialized', 'true');
            });
        }
        
        // 处理编辑图标点击
        function handleEditIconClick(e) {
            e.stopPropagation();
            e.preventDefault();
            
            // 查找对应的可编辑元素
            // 编辑图标可能是editable的下一个兄弟元素
            let editable = e.target.previousElementSibling;
            
            // 如果前一个元素不是editable，可能是光标元素，继续向前查找
            while (editable && !editable.classList.contains('editable')) {
                editable = editable.previousElementSibling;
            }
            
            if (editable && editable.classList.contains('editable')) {
                startEdit(editable);
            }
        }
        
        // 开始编辑
        function startEdit(elem) {
            // 如果已经在编辑中，不重复操作
            if (elem.contentEditable === 'true') return;
            
            // 保存原始内容
            editingElements.set(elem, elem.textContent);
            
            // 设置可编辑
            elem.contentEditable = true;
            elem.classList.add('editing');
            elem.focus();
            
            // 选中所有文本
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(elem);
            sel.removeAllRanges();
            sel.addRange(range);
            
            // 显示保存/取消按钮
            const parent = elem.parentElement;
            const controls = parent.querySelector('.edit-controls');
            if (controls) {
                controls.classList.add('show');
            }
            
            // 隐藏编辑图标
            const editIcon = parent.querySelector('.edit-icon');
            if (editIcon) {
                editIcon.style.display = 'none';
            }
            
            // 添加键盘事件
            elem.addEventListener('keydown', handleKeyDown);
        }
        
        // 处理键盘事件
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const parent = e.target.parentElement;
                const saveBtn = parent.querySelector('.save-btn');
                if (saveBtn) {
                    saveBtn.click();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                const parent = e.target.parentElement;
                const cancelBtn = parent.querySelector('.cancel-btn');
                if (cancelBtn) {
                    cancelBtn.click();
                }
            }
        }
        
        // 保存按钮点击
        function saveEditBtn(btn, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            const parent = btn.parentElement.parentElement;
            const editable = parent.querySelector('.editable');
            if (editable) {
                saveEdit(editable);
            }
            return false;
        }
        
        // 取消按钮点击
        function cancelEditBtn(btn, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            const parent = btn.parentElement.parentElement;
            const editable = parent.querySelector('.editable');
            if (editable) {
                cancelEdit(editable);
            }
            return false;
        }
        
        // 保存编辑
        function saveEdit(elem) {
            // 避免重复调用
            if (!elem || elem.contentEditable !== 'true') return;
            
            const newContent = elem.textContent.trim();
            const type = elem.dataset.type;
            const id = elem.dataset.id;
            const originalContent = editingElements.get(elem);
            
            // 先退出编辑状态
            elem.contentEditable = false;
            elem.classList.remove('editing');
            
            // 使用setTimeout确保DOM更新完成
            setTimeout(() => {
                // 隐藏控制按钮
                const parent = elem.parentElement;
                const controls = parent.querySelector('.edit-controls');
                if (controls) {
                    controls.classList.remove('show');
                }
                
                // 显示编辑图标
                const editIcon = parent.querySelector('.edit-icon');
                if (editIcon) {
                    editIcon.style.display = '';
                }
            }, 10);
            
            // 移除事件监听器
            elem.removeEventListener('keydown', handleKeyDown);
            
            // 如果内容有变化，保存到localStorage
            if (newContent !== originalContent) {
                saveToLocalStorage(type, id, newContent);
                showSaveHint();
                
                // 更新对应的mock数据
                updateMockData(type, id, newContent);
            }
            
            // 清除编辑记录
            editingElements.delete(elem);
        }
        
        // 取消编辑
        function cancelEdit(elem) {
            // 避免重复调用
            if (!elem || elem.contentEditable !== 'true') return;
            
            const originalContent = editingElements.get(elem);
            if (originalContent !== undefined) {
                elem.textContent = originalContent;
            }
            
            // 先退出编辑状态
            elem.contentEditable = false;
            elem.classList.remove('editing');
            
            // 使用setTimeout确保DOM更新完成
            setTimeout(() => {
                // 隐藏控制按钮
                const parent = elem.parentElement;
                const controls = parent.querySelector('.edit-controls');
                if (controls) {
                    controls.classList.remove('show');
                }
                
                // 显示编辑图标
                const editIcon = parent.querySelector('.edit-icon');
                if (editIcon) {
                    editIcon.style.display = '';
                }
            }, 10);
            
            // 移除事件监听器
            elem.removeEventListener('keydown', handleKeyDown);
            
            // 清除编辑记录
            editingElements.delete(elem);
        }
        
        // 保存到localStorage
        function saveToLocalStorage(type, id, content) {
            const key = `novel_${type}_${id}`;
            localStorage.setItem(key, content);
            console.log(`✅ 已保存: ${type}_${id}`, content);
        }
        
        // 更新mock数据
        function updateMockData(type, id, content) {
            if (type === 'idea-title') {
                const index = parseInt(id) - 1;
                if (mockIdeas[index]) {
                    mockIdeas[index].title = content;
                }
            } else if (type === 'idea-content') {
                const index = parseInt(id) - 1;
                if (mockIdeas[index]) {
                    mockIdeas[index].content = content;
                }
            } else if (type === 'outline-title') {
                mockOutline.title = content;
            } else if (type === 'outline-genre') {
                mockOutline.genre = content;
            } else if (type.startsWith('chapter-')) {
                const parts = type.split('-');
                const chapterIndex = parseInt(id) - 1;
                if (mockOutline.chapters[chapterIndex]) {
                    if (parts[1] === 'title') {
                        mockOutline.chapters[chapterIndex].title = content;
                    } else if (parts[1] === 'summary') {
                        mockOutline.chapters[chapterIndex].summary = content;
                    }
                }
            }
        }
        
        // 从 localStorage加载内容
        function loadFromLocalStorage() {
            // 加载脑洞数据
            mockIdeas.forEach((idea, index) => {
                const titleKey = `novel_idea-title_${index + 1}`;
                const contentKey = `novel_idea-content_${index + 1}`;
                
                const savedTitle = localStorage.getItem(titleKey);
                const savedContent = localStorage.getItem(contentKey);
                
                if (savedTitle) idea.title = savedTitle;
                if (savedContent) idea.content = savedContent;
            });
            
            // 加载大纲数据
            const outlineTitle = localStorage.getItem('novel_outline-title_1');
            const outlineGenre = localStorage.getItem('novel_outline-genre_1');
            
            if (outlineTitle) mockOutline.title = outlineTitle;
            if (outlineGenre) mockOutline.genre = outlineGenre;
            
            // 加载章节数据
            mockOutline.chapters.forEach((chapter, index) => {
                const titleKey = `novel_chapter-title_${index + 1}`;
                const summaryKey = `novel_chapter-summary_${index + 1}`;
                
                const savedTitle = localStorage.getItem(titleKey);
                const savedSummary = localStorage.getItem(summaryKey);
                
                if (savedTitle) chapter.title = savedTitle;
                if (savedSummary) chapter.summary = savedSummary;
            });
        }
        
        // 显示保存提示
        function showSaveHint() {
            const hint = document.getElementById('saveHint');
            hint.classList.add('show');
            
            setTimeout(() => {
                hint.classList.remove('show');
            }, 2000);
        }
        
        // 显示底部控制区域
        function showBottomControls() {
            const controls = document.getElementById('ideasBottomControls');
            if (controls) {
                // 显示元素
                controls.style.display = 'block';
                
                // 触发动画
                setTimeout(() => {
                    controls.classList.remove('opacity-0', 'translate-y-4');
                    controls.classList.add('opacity-100', 'translate-y-0');
                }, 50);
                
                // 启用下一步按钮（如果有选中的脑洞）
                if (selectedIdea) {
                    const nextBtn = document.getElementById('nextToOutlineBtn');
                    if (nextBtn) {
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                        nextBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-500', 'text-white', 'hover:shadow-lg');
                    }
                }
            }
        }
        
        // 隐藏底部控制区域
        function hideBottomControls() {
            const controls = document.getElementById('ideasBottomControls');
            if (controls) {
                controls.classList.add('opacity-0', 'translate-y-4');
                controls.classList.remove('opacity-100', 'translate-y-0');
                
                setTimeout(() => {
                    controls.style.display = 'none';
                }, 500);
            }
        }
        
        // 初始化时加载localStorage数据
        loadFromLocalStorage();
        
        // 初始化
        updateUI();
    </script>
</body>
</html>